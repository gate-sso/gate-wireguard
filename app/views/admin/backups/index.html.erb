<% content_for :title, "System Backup" %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-shield-check me-2"></i>System Backup & Restore</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><%= link_to "Admin", root_path %></li>
            <li class="breadcrumb-item active" aria-current="page">Backup</li>
          </ol>
        </nav>
      </div>

      <% if notice %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i><%= notice %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% end %>

      <% if alert %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i><%= alert %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% end %>

      <div class="row">
        <!-- Backup Information Card -->
        <div class="col-md-6 mb-4">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="bi bi-info-circle me-2"></i>Current System Status
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6">
                  <div class="text-center p-3 bg-light rounded">
                    <div class="h4 text-primary mb-1"><%= @backup_info[:vpn_configurations_count] %></div>
                    <small class="text-muted">VPN Configurations</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-3 bg-light rounded">
                    <div class="h4 text-success mb-1"><%= @backup_info[:vpn_devices_count] %></div>
                    <small class="text-muted">VPN Devices</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-3 bg-light rounded">
                    <div class="h4 text-info mb-1"><%= @backup_info[:users_count] %></div>
                    <small class="text-muted">Users</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-3 bg-light rounded">
                    <div class="h4 text-warning mb-1"><%= @backup_info[:network_addresses_count] %></div>
                    <small class="text-muted">Network Addresses</small>
                  </div>
                </div>
              </div>
              
              <% if @backup_info[:last_backup] %>
                <div class="mt-3 pt-3 border-top">
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    Last backup: <%= @backup_info[:last_backup].strftime("%B %d, %Y at %I:%M %p") %>
                  </small>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Backup Actions Card -->
        <div class="col-md-6 mb-4">
          <div class="card h-100">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0">
                <i class="bi bi-download me-2"></i>Create Backup
              </h5>
            </div>
            <div class="card-body">
              <p class="card-text">
                Download a complete backup of your VPN system configuration including:
              </p>
              <ul class="list-unstyled">
                <li><i class="bi bi-check text-success me-2"></i>VPN server configuration</li>
                <li><i class="bi bi-check text-success me-2"></i>All user devices</li>
                <li><i class="bi bi-check text-success me-2"></i>User accounts</li>
                <li><i class="bi bi-check text-success me-2"></i>Network settings</li>
                <li><i class="bi bi-check text-success me-2"></i>DNS records</li>
              </ul>
              
              <div class="d-grid gap-2 mt-4">
                <%= link_to admin_backup_download_path, 
                    class: "btn btn-success btn-lg", 
                    data: { 
                      turbo_method: :get,
                      confirm: "This will download a complete system backup. Continue?" 
                    } do %>
                  <i class="bi bi-download me-2"></i>Download Backup
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Restore Section -->
      <div class="row">
        <div class="col-12">
          <div class="card mx-auto" style="max-width: 800px;">
            <div class="card-header bg-warning text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-upload me-2"></i>Restore from Backup
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Restoring from backup will merge or replace existing data. 
                Please ensure you have a current backup before proceeding.
              </div>

              <%= form_with url: admin_backup_restore_path, 
                           method: :post, 
                           multipart: true, 
                           class: "row g-3 align-items-end",
                           data: { turbo: false } do |form| %>
                
                <div class="col-md-6">
                  <label for="backup_file" class="form-label">
                    <i class="bi bi-file-earmark-text me-1"></i>Select Backup File
                  </label>
                  <%= form.file_field :backup_file, 
                      accept: ".json", 
                      required: true,
                      class: "form-control" %>
                  <div class="form-text">Only JSON backup files are supported</div>
                </div>

                <div class="col-md-4">
                  <div class="form-check">
                    <%= form.check_box :clear_existing, 
                        class: "form-check-input" %>
                    <label class="form-check-label text-danger" for="clear_existing">
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      Clear existing devices before restore
                    </label>
                    <div class="form-text">
                      <small class="text-muted">Use with caution - this will delete all current VPN devices</small>
                    </div>
                  </div>
                </div>

                <div class="col-md-2">
                  <%= form.submit "Restore Backup", 
                      class: "btn btn-warning w-100",
                      data: { 
                        confirm: "Are you sure you want to restore from this backup? This action cannot be undone."
                      } %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-question-circle me-2"></i>Backup Instructions
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-primary">Creating Backups</h6>
                  <ul>
                    <li>Click "Download Backup" to create a JSON backup file</li>
                    <li>Store backup files in a secure location</li>
                    <li>Regular backups are recommended before major changes</li>
                    <li>Backup includes all system configuration and user data</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">Restoring Backups</h6>
                  <ul>
                    <li>Select a valid JSON backup file created by this system</li>
                    <li>Choose whether to clear existing devices first</li>
                    <li>Restore process merges users and updates configurations</li>
                    <li>Always test restore on a non-production system first</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.15s ease-in-out;
  }
  
  .card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .bg-light {
    border-radius: 8px;
  }
  
  .btn-lg {
    padding: 0.75rem 1.5rem;
  }
</style>